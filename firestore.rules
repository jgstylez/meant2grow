rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== HELPER FUNCTIONS ====================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get the current user's document
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user belongs to specific organization
    function belongsToOrg(organizationId) {
      return isAuthenticated() && 
             getUserData().organizationId == organizationId;
    }
    
    // Check if user is organization admin
    function isOrgAdmin(organizationId) {
      return isAuthenticated() && 
             belongsToOrg(organizationId) &&
             getUserData().role == 'ORGANIZATION_ADMIN';
    }
    
    // Check if user is platform admin
    function isPlatformAdmin() {
      return isAuthenticated() && 
             getUserData().role == 'PLATFORM_ADMIN';
    }
    
    // Check if user owns the resource (by userId field)
    function isOwner(userId) {
      return isAuthenticated() && 
             request.auth.uid == userId;
    }
    
    // Check if document belongs to user's organization
    function isOrgScoped(organizationId) {
      return belongsToOrg(organizationId) || isPlatformAdmin();
    }
    
    // ==================== ORGANIZATIONS ====================
    
    match /organizations/{orgId} {
      // Anyone authenticated can create an organization (for signup)
      allow create: if isAuthenticated();
      
      // Users can read their own organization, platform admins can read all
      allow read: if belongsToOrg(orgId) || isPlatformAdmin();
      
      // Only organization admins can update their org, platform admins can update any
      allow update: if isOrgAdmin(orgId) || isPlatformAdmin();
      
      // Only platform admins can delete organizations
      allow delete: if isPlatformAdmin();
    }
    
    // ==================== USERS ====================
    
    match /users/{userId} {
      // Anyone authenticated can create a user (for signup)
      allow create: if isAuthenticated();
      
      // Users can read users in their organization, or their own profile, platform admins can read all
      allow read: if belongsToOrg(resource.data.organizationId) || 
                     request.auth.uid == userId || 
                     isPlatformAdmin();
      
      // Users can update their own profile, org admins can update users in their org, platform admins can update any
      allow update: if request.auth.uid == userId ||
                     (belongsToOrg(resource.data.organizationId) && isOrgAdmin(resource.data.organizationId)) ||
                     isPlatformAdmin();
      
      // Only platform admins can delete users
      allow delete: if isPlatformAdmin();
    }
    
    // ==================== MATCHES ====================
    
    match /matches/{matchId} {
      // Users can create matches in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId);
      
      // Users can read matches in their organization
      allow read: if isOrgScoped(resource.data.organizationId);
      
      // Users can update matches in their organization (participants or org admins)
      allow update: if isOrgScoped(resource.data.organizationId) &&
                      (request.auth.uid == resource.data.mentorId ||
                       request.auth.uid == resource.data.menteeId ||
                       isOrgAdmin(resource.data.organizationId));
      
      // Users can delete matches they're part of, or org admins can delete in their org
      allow delete: if isOrgScoped(resource.data.organizationId) &&
                      (request.auth.uid == resource.data.mentorId ||
                       request.auth.uid == resource.data.menteeId ||
                       isOrgAdmin(resource.data.organizationId));
    }
    
    // ==================== GOALS ====================
    
    match /goals/{goalId} {
      // Users can create goals in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId);
      
      // Users can read goals in their organization
      allow read: if isOrgScoped(resource.data.organizationId);
      
      // Users can update their own goals, or org admins can update any in their org
      allow update: if isOrgScoped(resource.data.organizationId) &&
                      (isOwner(resource.data.userId) ||
                       isOrgAdmin(resource.data.organizationId));
      
      // Users can delete their own goals, or org admins can delete any in their org
      allow delete: if isOrgScoped(resource.data.organizationId) &&
                      (isOwner(resource.data.userId) ||
                       isOrgAdmin(resource.data.organizationId));
    }
    
    // ==================== MILESTONES ====================
    
    match /milestones/{milestoneId} {
      // Users can create milestones in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId);
      
      // Users can read milestones in their organization
      allow read: if isOrgScoped(resource.data.organizationId);
      
      // Users can update milestones in their organization
      allow update: if isOrgScoped(resource.data.organizationId);
      
      // Users can delete milestones in their organization
      allow delete: if isOrgScoped(resource.data.organizationId);
    }
    
    // ==================== CALENDAR EVENTS ====================
    
    match /calendarEvents/{eventId} {
      // Users can create events in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId);
      
      // Users can read events in their organization
      allow read: if isOrgScoped(resource.data.organizationId);
      
      // Users can update events they're part of, or org admins can update any in their org
      allow update: if isOrgScoped(resource.data.organizationId) &&
                      (request.auth.uid == resource.data.mentorId ||
                       request.auth.uid == resource.data.menteeId ||
                       isOrgAdmin(resource.data.organizationId));
      
      // Users can delete events they're part of, or org admins can delete any in their org
      allow delete: if isOrgScoped(resource.data.organizationId) &&
                      (request.auth.uid == resource.data.mentorId ||
                       request.auth.uid == resource.data.menteeId ||
                       isOrgAdmin(resource.data.organizationId));
    }
    
    // ==================== RESOURCES ====================
    
    match /resources/{resourceId} {
      // Users can create resources in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId);
      
      // Users can read resources in their organization
      allow read: if isOrgScoped(resource.data.organizationId);
      
      // Org admins can update resources in their org, platform admins can update any
      allow update: if isOrgAdmin(resource.data.organizationId) || isPlatformAdmin();
      
      // Org admins can delete resources in their org, platform admins can delete any
      allow delete: if isOrgAdmin(resource.data.organizationId) || isPlatformAdmin();
    }
    
    // ==================== NOTIFICATIONS ====================
    
    match /notifications/{notificationId} {
      // Users can create notifications in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId);
      
      // Users can only read their own notifications, or org admins can read all in their org
      allow read: if isOwner(resource.data.userId) ||
                     (belongsToOrg(resource.data.organizationId) && isOrgAdmin(resource.data.organizationId)) ||
                     isPlatformAdmin();
      
      // Users can update their own notifications
      allow update: if isOwner(resource.data.userId) || isPlatformAdmin();
      
      // Users can delete their own notifications
      allow delete: if isOwner(resource.data.userId) || isPlatformAdmin();
    }
    
    // ==================== INVITATIONS ====================
    
    match /invitations/{invitationId} {
      // Users can create invitations in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId);
      
      // Users can read invitations in their organization
      allow read: if isOrgScoped(resource.data.organizationId);
      
      // Org admins can update invitations in their org
      allow update: if isOrgAdmin(resource.data.organizationId) || isPlatformAdmin();
      
      // Org admins can delete invitations in their org
      allow delete: if isOrgAdmin(resource.data.organizationId) || isPlatformAdmin();
    }
    
    // ==================== RATINGS ====================
    
    match /ratings/{ratingId} {
      // Users can create ratings in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId);
      
      // Users can read ratings in their organization
      allow read: if isOrgScoped(resource.data.organizationId);
      
      // Users can update their own ratings, or org admins can update any in their org
      allow update: if isOrgScoped(resource.data.organizationId) &&
                      (isOwner(resource.data.userId) ||
                       isOrgAdmin(resource.data.organizationId));
      
      // Users can delete their own ratings, or org admins can delete any in their org
      allow delete: if isOrgScoped(resource.data.organizationId) &&
                      (isOwner(resource.data.userId) ||
                       isOrgAdmin(resource.data.organizationId));
    }
    
    // ==================== CHAT MESSAGES ====================
    
    match /chatMessages/{messageId} {
      // Users can create messages in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId) &&
                      request.auth.uid == request.resource.data.senderId;
      
      // Users can read messages in their organization
      allow read: if isOrgScoped(resource.data.organizationId);
      
      // Users can update their own messages
      allow update: if isOrgScoped(resource.data.organizationId) &&
                      request.auth.uid == resource.data.senderId;
      
      // Users can delete their own messages, or org admins can delete any in their org
      allow delete: if isOrgScoped(resource.data.organizationId) &&
                      (request.auth.uid == resource.data.senderId ||
                       isOrgAdmin(resource.data.organizationId));
    }
    
    // ==================== CHAT GROUPS ====================
    
    match /chatGroups/{groupId} {
      // Users can create groups in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId);
      
      // Users can read groups in their organization (membership checked client-side)
      allow read: if isOrgScoped(resource.data.organizationId);
      
      // Org admins can update groups in their org, or group members (checked client-side)
      allow update: if isOrgAdmin(resource.data.organizationId) || isPlatformAdmin();
      
      // Org admins can delete groups in their org
      allow delete: if isOrgAdmin(resource.data.organizationId) || isPlatformAdmin();
    }
    
    // ==================== PRIVATE MESSAGE REQUESTS ====================
    
    match /privateMessageRequests/{requestId} {
      // Users can create requests in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId) &&
                      request.auth.uid == request.resource.data.requesterId;
      
      // Users can read their own requests (as requester or recipient)
      allow read: if isOrgScoped(resource.data.organizationId) &&
                     (request.auth.uid == resource.data.requesterId ||
                      request.auth.uid == resource.data.recipientId);
      
      // Recipients can update requests (approve/reject), or org admins can update any
      allow update: if isOrgScoped(resource.data.organizationId) &&
                      (request.auth.uid == resource.data.recipientId ||
                       isOrgAdmin(resource.data.organizationId));
      
      // Requesters can delete their own requests, or org admins can delete any
      allow delete: if isOrgScoped(resource.data.organizationId) &&
                      (request.auth.uid == resource.data.requesterId ||
                       isOrgAdmin(resource.data.organizationId));
    }
    
    // ==================== BLOG POSTS (Platform-wide) ====================
    
    match /blogPosts/{postId} {
      // Anyone can read blog posts
      allow read: if true;
      
      // Only platform admins can create/update/delete blog posts
      allow create, update, delete: if isPlatformAdmin();
    }
    
    // ==================== DISCUSSION GUIDES ====================
    
    match /discussionGuides/{guideId} {
      // Platform admins can create guides, or org admins can create for their org
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() ||
                       (belongsToOrg(request.resource.data.organizationId) && 
                        isOrgAdmin(request.resource.data.organizationId)));
      
      // Users can read guides in their organization, or platform-wide guides
      allow read: if !exists(resource.data.organizationId) || // Platform-wide
                     isOrgScoped(resource.data.organizationId);
      
      // Platform admins can update any, org admins can update guides in their org
      allow update: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
      
      // Platform admins can delete any, org admins can delete guides in their org
      allow delete: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
    }
    
    // ==================== CAREER TEMPLATES ====================
    
    match /careerTemplates/{templateId} {
      // Platform admins can create templates, or org admins can create for their org
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() ||
                       (belongsToOrg(request.resource.data.organizationId) && 
                        isOrgAdmin(request.resource.data.organizationId)));
      
      // Users can read templates in their organization, or platform-wide templates
      allow read: if !exists(resource.data.organizationId) || // Platform-wide
                     isOrgScoped(resource.data.organizationId);
      
      // Platform admins can update any, org admins can update templates in their org
      allow update: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
      
      // Platform admins can delete any, org admins can delete templates in their org
      allow delete: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
    }
    
    // ==================== TRAINING VIDEOS ====================
    
    match /trainingVideos/{videoId} {
      // Platform admins can create videos, or org admins can create for their org
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() ||
                       (belongsToOrg(request.resource.data.organizationId) && 
                        isOrgAdmin(request.resource.data.organizationId)));
      
      // Users can read videos in their organization, or platform-wide videos
      allow read: if !exists(resource.data.organizationId) || // Platform-wide
                     isOrgScoped(resource.data.organizationId);
      
      // Platform admins can update any, org admins can update videos in their org
      allow update: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
      
      // Platform admins can delete any, org admins can delete videos in their org
      allow delete: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
    }
  }
}
