rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==================== HELPER FUNCTIONS ====================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user document exists
    function userExists() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    // Get the current user's document data (only call if userExists() is true)
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Check if user belongs to specific organization
    function belongsToOrg(organizationId) {
      return isAuthenticated() && 
             userExists() &&
             getUserData().organizationId != null &&
             getUserData().organizationId == organizationId;
    }
    
    // Check if user is organization admin
    function isOrgAdmin(organizationId) {
      return isAuthenticated() && 
             userExists() &&
             belongsToOrg(organizationId) &&
             getUserData().role == 'ORGANIZATION_ADMIN';
    }
    
    // Check if user is platform admin
    function isPlatformAdmin() {
      return isAuthenticated() && 
             userExists() &&
             (getUserData().role == 'PLATFORM_ADMIN' || 
              getUserData().role == 'PLATFORM_OPERATOR' ||
              getUserData().organizationId == 'platform');
    }
    
    // Check if user owns the resource (by userId field)
    function isOwner(userId) {
      return isAuthenticated() && 
             request.auth.uid == userId;
    }
    
    // Check if document belongs to user's organization
    // Platform admins can access all documents regardless of organizationId
    function isOrgScoped(organizationId) {
      return isPlatformAdmin() || belongsToOrg(organizationId);
    }
    
    // Validate organization data on create
    function isValidOrganization() {
      let data = request.resource.data;
      return data.name is string && 
             data.name.size() > 0 &&
             data.createdAt is timestamp &&
             data.organizationCode is string &&
             data.organizationCode.size() > 0 &&
             (!exists(data.subscriptionTier) || 
              data.subscriptionTier in ['free', 'starter', 'professional', 'business', 'enterprise']);
    }
    
    // Validate user data on create
    function isValidUser() {
      let data = request.resource.data;
      // Basic email validation (contains @ and .)
      let emailValid = data.email is string && 
                       data.email.size() > 0 &&
                       data.email.matches('.*@.*\\..*');
      return data.organizationId is string &&
             data.organizationId.size() > 0 &&
             data.name is string &&
             data.name.size() > 0 &&
             emailValid &&
             data.role is string &&
             data.role.size() > 0 &&
             data.createdAt is timestamp;
    }
    
    // ==================== ORGANIZATIONS ====================
    
    match /organizations/{orgId} {
      // Allow unauthenticated users to create organizations (for signup) with validation
      // Also allow authenticated users to create organizations with validation
      allow create: if isValidOrganization();
      
      // Users can read their own organization, platform admins can read all
      // Also allow unauthenticated reads for organization code lookups during signup
      allow read: if belongsToOrg(orgId) || 
                     isPlatformAdmin() ||
                     // Allow unauthenticated reads for signup flow (organization code lookups)
                     request.auth == null;
      
      // Allow updates during signup (for setting trial info) or by org admins/platform admins
      allow update: if request.auth == null || // Allow during signup flow
                     isOrgAdmin(orgId) || 
                     isPlatformAdmin();
      
      // Only platform admins can delete organizations
      allow delete: if isPlatformAdmin();
    }
    
    // ==================== USERS ====================
    
    match /users/{userId} {
      // Allow unauthenticated users to create accounts (for signup) with validation
      // Also allow authenticated users to create users with validation
      allow create: if isValidUser();
      
      // Users can read users in their organization, or their own profile, platform admins can read all
      // Also allow unauthenticated reads for email lookups during login
      // Note: This allows checking if an email exists, which is needed for login but is a minor security trade-off
      allow read: if belongsToOrg(resource.data.organizationId) || 
                     request.auth.uid == userId || 
                     isPlatformAdmin() ||
                     // Allow unauthenticated reads for login flow (email lookups)
                     request.auth == null;
      
      // Users can update their own profile, org admins can update users in their org, platform admins can update any
      allow update: if request.auth.uid == userId ||
                     (belongsToOrg(resource.data.organizationId) && isOrgAdmin(resource.data.organizationId)) ||
                     isPlatformAdmin();
      
      // Only platform admins can delete users
      allow delete: if isPlatformAdmin();
    }
    
    // ==================== MATCHES ====================
    
    match /matches/{matchId} {
      // Users can create matches in their organization, platform admins can create anywhere
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() || belongsToOrg(request.resource.data.organizationId));
      
      // Users can read matches in their organization, platform admins can read all
      allow read: if isPlatformAdmin() || isOrgScoped(resource.data.organizationId);
      
      // Users can update matches in their organization (participants or org admins)
      // Platform admins can update any match
      allow update: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (request.auth.uid == resource.data.mentorId ||
                        request.auth.uid == resource.data.menteeId ||
                        isOrgAdmin(resource.data.organizationId)));
      
      // Users can delete matches they're part of, or org admins can delete in their org
      // Platform admins can delete any match
      allow delete: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (request.auth.uid == resource.data.mentorId ||
                        request.auth.uid == resource.data.menteeId ||
                        isOrgAdmin(resource.data.organizationId)));
    }
    
    // ==================== GOALS ====================
    
    match /goals/{goalId} {
      // Users can create goals in their organization, platform admins can create anywhere
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() || belongsToOrg(request.resource.data.organizationId));
      
      // Users can read goals in their organization, platform admins can read all
      allow read: if isPlatformAdmin() || isOrgScoped(resource.data.organizationId);
      
      // Users can update their own goals, or org admins can update any in their org
      // Platform admins can update any goal
      allow update: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (isOwner(resource.data.userId) ||
                        isOrgAdmin(resource.data.organizationId)));
      
      // Users can delete their own goals, or org admins can delete any in their org
      // Platform admins can delete any goal
      allow delete: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (isOwner(resource.data.userId) ||
                        isOrgAdmin(resource.data.organizationId)));
    }
    
    // ==================== MILESTONES ====================
    
    match /milestones/{milestoneId} {
      // Users can create milestones in their organization
      allow create: if isAuthenticated() && 
                      belongsToOrg(request.resource.data.organizationId);
      
      // Users can read milestones in their organization
      allow read: if isOrgScoped(resource.data.organizationId);
      
      // Users can update milestones in their organization
      allow update: if isOrgScoped(resource.data.organizationId);
      
      // Users can delete milestones in their organization
      allow delete: if isOrgScoped(resource.data.organizationId);
    }
    
    // ==================== CALENDAR EVENTS ====================
    
    match /calendarEvents/{eventId} {
      // Users can create events in their organization, platform admins can create anywhere
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() || belongsToOrg(request.resource.data.organizationId));
      
      // Users can read events in their organization, platform admins can read all
      allow read: if isPlatformAdmin() || isOrgScoped(resource.data.organizationId);
      
      // Users can update events they're part of, or org admins can update any in their org
      // Platform admins can update any event
      allow update: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (request.auth.uid == resource.data.mentorId ||
                        request.auth.uid == resource.data.menteeId ||
                        isOrgAdmin(resource.data.organizationId)));
      
      // Users can delete events they're part of, or org admins can delete any in their org
      // Platform admins can delete any event
      allow delete: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (request.auth.uid == resource.data.mentorId ||
                        request.auth.uid == resource.data.menteeId ||
                        isOrgAdmin(resource.data.organizationId)));
    }
    
    // ==================== RESOURCES ====================
    
    match /resources/{resourceId} {
      // Users can create resources in their organization, platform admins can create anywhere
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() || belongsToOrg(request.resource.data.organizationId));
      
      // Users can read resources in their organization, platform admins can read all
      allow read: if isPlatformAdmin() || isOrgScoped(resource.data.organizationId);
      
      // Org admins can update resources in their org, platform admins can update any
      allow update: if isPlatformAdmin() || isOrgAdmin(resource.data.organizationId);
      
      // Org admins can delete resources in their org, platform admins can delete any
      allow delete: if isPlatformAdmin() || isOrgAdmin(resource.data.organizationId);
    }
    
    // ==================== NOTIFICATIONS ====================
    
    match /notifications/{notificationId} {
      // Users can create notifications in their organization, platform admins can create anywhere
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() || belongsToOrg(request.resource.data.organizationId));
      
      // Users can only read their own notifications, or org admins can read all in their org
      // Platform admins can read all notifications
      allow read: if isPlatformAdmin() ||
                     isOwner(resource.data.userId) ||
                     (belongsToOrg(resource.data.organizationId) && isOrgAdmin(resource.data.organizationId));
      
      // Users can update their own notifications, platform admins can update any
      allow update: if isPlatformAdmin() || isOwner(resource.data.userId);
      
      // Users can delete their own notifications, platform admins can delete any
      allow delete: if isPlatformAdmin() || isOwner(resource.data.userId);
    }
    
    // ==================== INVITATIONS ====================
    
    match /invitations/{invitationId} {
      // Users can create invitations in their organization, platform admins can create anywhere
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() || belongsToOrg(request.resource.data.organizationId));
      
      // Users can read invitations in their organization, platform admins can read all
      // Also allow unauthenticated reads for invitation-based signup
      allow read: if isPlatformAdmin() ||
                     isOrgScoped(resource.data.organizationId) ||
                     // Allow unauthenticated reads for invitation token lookups during signup
                     request.auth == null;
      
      // Org admins can update invitations in their org, platform admins can update any
      // Also allow unauthenticated updates for accepting invitations during signup
      allow update: if isPlatformAdmin() ||
                     request.auth == null || // Allow during signup flow (accepting invitation)
                     isOrgAdmin(resource.data.organizationId);
      
      // Org admins can delete invitations in their org, platform admins can delete any
      allow delete: if isPlatformAdmin() || isOrgAdmin(resource.data.organizationId);
    }
    
    // ==================== RATINGS ====================
    
    match /ratings/{ratingId} {
      // Users can create ratings in their organization, platform admins can create anywhere
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() || belongsToOrg(request.resource.data.organizationId));
      
      // Users can read ratings in their organization, platform admins can read all
      allow read: if isPlatformAdmin() || isOrgScoped(resource.data.organizationId);
      
      // Users can update their own ratings, or org admins can update any in their org
      // Platform admins can update any rating
      allow update: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (isOwner(resource.data.userId) ||
                        isOrgAdmin(resource.data.organizationId)));
      
      // Users can delete their own ratings, or org admins can delete any in their org
      // Platform admins can delete any rating
      allow delete: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (isOwner(resource.data.userId) ||
                        isOrgAdmin(resource.data.organizationId)));
    }
    
    // ==================== CHAT MESSAGES ====================
    
    match /chatMessages/{messageId} {
      // Users can create messages in their organization, platform admins can create anywhere
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() || 
                       (belongsToOrg(request.resource.data.organizationId) &&
                        request.auth.uid == request.resource.data.senderId));
      
      // Users can read messages in their organization, platform admins can read all
      allow read: if isPlatformAdmin() || isOrgScoped(resource.data.organizationId);
      
      // Users can update their own messages, platform admins can update any
      allow update: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       request.auth.uid == resource.data.senderId);
      
      // Users can delete their own messages, or org admins can delete any in their org
      // Platform admins can delete any message
      allow delete: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (request.auth.uid == resource.data.senderId ||
                        isOrgAdmin(resource.data.organizationId)));
    }
    
    // ==================== CHAT GROUPS ====================
    
    match /chatGroups/{groupId} {
      // Users can create groups in their organization, platform admins can create anywhere
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() || belongsToOrg(request.resource.data.organizationId));
      
      // Users can read groups in their organization (membership checked client-side)
      // Platform admins can read all groups
      allow read: if isPlatformAdmin() || isOrgScoped(resource.data.organizationId);
      
      // Org admins can update groups in their org, or group members (checked client-side)
      // Platform admins can update any group
      allow update: if isPlatformAdmin() || isOrgAdmin(resource.data.organizationId);
      
      // Org admins can delete groups in their org, platform admins can delete any
      allow delete: if isPlatformAdmin() || isOrgAdmin(resource.data.organizationId);
    }
    
    // ==================== PRIVATE MESSAGE REQUESTS ====================
    
    match /privateMessageRequests/{requestId} {
      // Users can create requests in their organization, platform admins can create anywhere
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() ||
                       (belongsToOrg(request.resource.data.organizationId) &&
                        request.auth.uid == request.resource.data.requesterId));
      
      // Users can read their own requests (as requester or recipient)
      // Platform admins can read all requests
      allow read: if isPlatformAdmin() ||
                     (isOrgScoped(resource.data.organizationId) &&
                      (request.auth.uid == resource.data.requesterId ||
                       request.auth.uid == resource.data.recipientId));
      
      // Recipients can update requests (approve/reject), or org admins can update any
      // Platform admins can update any request
      allow update: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (request.auth.uid == resource.data.recipientId ||
                        isOrgAdmin(resource.data.organizationId)));
      
      // Requesters can delete their own requests, or org admins can delete any
      // Platform admins can delete any request
      allow delete: if isPlatformAdmin() ||
                      (isOrgScoped(resource.data.organizationId) &&
                       (request.auth.uid == resource.data.requesterId ||
                        isOrgAdmin(resource.data.organizationId)));
    }
    
    // ==================== BLOG POSTS (Platform-wide) ====================
    
    match /blogPosts/{postId} {
      // Anyone can read blog posts
      allow read: if true;
      
      // Only platform admins can create/update/delete blog posts
      allow create, update, delete: if isPlatformAdmin();
    }
    
    // ==================== DISCUSSION GUIDES ====================
    
    match /discussionGuides/{guideId} {
      // Platform admins can create guides, or org admins can create for their org
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() ||
                       (belongsToOrg(request.resource.data.organizationId) && 
                        isOrgAdmin(request.resource.data.organizationId)));
      
      // Users can read guides in their organization, or platform-wide guides
      // Platform admins can read all guides
      allow read: if isPlatformAdmin() ||
                     (resource.data.isPlatform == true || !exists(resource.data.organizationId)) || // Platform-wide
                     isOrgScoped(resource.data.organizationId);
      
      // Platform admins can update any, org admins can update guides in their org
      allow update: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
      
      // Platform admins can delete any, org admins can delete guides in their org
      allow delete: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
    }
    
    // ==================== CAREER TEMPLATES ====================
    
    match /careerTemplates/{templateId} {
      // Platform admins can create templates, or org admins can create for their org
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() ||
                       (belongsToOrg(request.resource.data.organizationId) && 
                        isOrgAdmin(request.resource.data.organizationId)));
      
      // Users can read templates in their organization, or platform-wide templates
      // Platform admins can read all templates
      allow read: if isPlatformAdmin() ||
                     (resource.data.isPlatform == true || !exists(resource.data.organizationId)) || // Platform-wide
                     isOrgScoped(resource.data.organizationId);
      
      // Platform admins can update any, org admins can update templates in their org
      allow update: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
      
      // Platform admins can delete any, org admins can delete templates in their org
      allow delete: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
    }
    
    // ==================== TRAINING VIDEOS ====================
    
    match /trainingVideos/{videoId} {
      // Platform admins can create videos, or org admins can create for their org
      allow create: if isAuthenticated() && 
                      (isPlatformAdmin() ||
                       (belongsToOrg(request.resource.data.organizationId) && 
                        isOrgAdmin(request.resource.data.organizationId)));
      
      // Users can read videos in their organization, or platform-wide videos
      // Platform admins can read all videos
      allow read: if isPlatformAdmin() ||
                     (resource.data.isPlatform == true || !exists(resource.data.organizationId)) || // Platform-wide
                     isOrgScoped(resource.data.organizationId);
      
      // Platform admins can update any, org admins can update videos in their org
      allow update: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
      
      // Platform admins can delete any, org admins can delete videos in their org
      allow delete: if isPlatformAdmin() ||
                      (exists(resource.data.organizationId) &&
                       isOrgAdmin(resource.data.organizationId));
    }
  }
}
